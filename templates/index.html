<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>The Healer's Scribe</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="/static/styles.css" rel="stylesheet">
  </head>
  <body class="app-page">
    <div class="container py-4">
      <!-- Header -->
      <div class="app-header mb-4">
        <a href="/" class="btn btn-ghost btn-sm">â† Back to Home</a>
        <h1 class="display-6 mt-3">
          <span class="gradient-text">ğŸ§™â€â™‚ï¸ The Healer's Scribe</span>
        </h1>
        <p class="lead text-muted">Extract wisdom from ancient healing scrolls</p>
      </div>

      <!-- Main Form Card -->
      <div class="card form-card mb-4">
        <div class="card-body">
          <form id="processForm" method="post" action="/app" enctype="multipart/form-data">
            
            <!-- Textarea Section -->
            <div class="mb-4">
              <label for="text" class="form-label d-flex align-items-center gap-2 justify-content-between">
                <span><span class="label-icon">ğŸ“œ</span> Paste Your Healing Scrolls</span>
                <small class="text-muted fst-italic" style="font-weight: 400;">Tip: Press Ctrl+Enter to submit</small>
              </label>
              <textarea 
                class="form-control scroll-textarea" 
                id="text" 
                name="text" 
                rows="12" 
                placeholder="Example: Dr. Elara used willow bark tea for the patient's fever. The fever subsided within hours.&#10;&#10;Healer Theron applied honey to the wound, but infection spread...">{{ text }}</textarea>
              <small class="form-text text-muted mt-2 d-block">
                ğŸ’¡ Tip: Include healer names, treatments, symptoms, and outcomes for best results
              </small>
            </div>

            <!-- File Upload Section -->
            <div class="row g-3 mb-4">
              <div class="col-md-8">
                <label for="file" class="form-label d-flex align-items-center gap-2">
                  <span class="label-icon">ğŸ“„</span>
                  <span>Or Upload a Document</span>
                </label>
                <input 
                  class="form-control file-input" 
                  type="file" 
                  id="file" 
                  name="file" 
                  accept=".pdf,.json,.txt">
                <small class="form-text text-muted d-block mt-1">
                  Supported: PDF, JSON, TXT
                </small>
              </div>
              <div class="col-md-4 d-flex align-items-end">
                <button id="processBtn" type="submit" class="btn btn-magical w-100 py-3">
                  <span class="btn-icon">âœ¨</span> Process Scrolls
                </button>
              </div>
            </div>

            <!-- Quick Actions -->
            <div class="quick-actions">
              <label class="form-label small text-muted mb-2">Quick Export Options:</label>
              <div class="d-flex flex-wrap gap-2">
                <button type="submit" formaction="/download" formmethod="post" class="btn btn-outline-secondary btn-sm">
                  <span>ğŸ“Š</span> CSV
                </button>
                <button type="submit" formaction="/download/json" formmethod="post" class="btn btn-outline-secondary btn-sm">
                  <span>ğŸ“‹</span> JSON
                </button>
                <button type="submit" formaction="/download/txt" formmethod="post" class="btn btn-outline-secondary btn-sm">
                  <span>ğŸ“</span> TXT
                </button>
                <button type="submit" formaction="/download/pdf" formmethod="post" class="btn btn-outline-secondary btn-sm">
                  <span>ğŸ“œ</span> PDF
                </button>
              </div>
            </div>

          </form>
        </div>
      </div>

      <!-- Sample Data Card -->
      <div class="card tips-card">
        <div class="card-body">
          <h6 class="card-title">ğŸ¯ Try Sample Data</h6>
          <p class="card-text small mb-2">Click below to load example healing records:</p>
          <button class="btn btn-light btn-sm" onclick="loadSampleData()">
            Load Sample Scrolls
          </button>
        </div>
      </div>

      <!-- Processing overlay -->
      <div id="processingOverlay" class="processing-overlay" style="display:none;">
        <div class="processing-card">
          <div class="mystical-orb mb-3">âœ¨</div>
          <div class="spinner-border text-primary mb-3" role="status" style="width: 3rem; height: 3rem;">
            <span class="visually-hidden">Processing...</span>
          </div>
          <div class="mt-3 fw-bold">âœ¨ Processing the scrolls...</div>
          <div class="small text-muted">Extracting wisdom from ancient texts</div>
          <div class="progress mt-3" style="height: 4px; width: 200px; margin: 0 auto;">
            <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 100%; background: linear-gradient(90deg, #7c3aed, #ec4899);"></div>
          </div>
        </div>
      </div>

      {% if summary %}
      <div class="card mt-4">
        <div class="card-body">
          <h4>Summary Wisdom</h4>
          <p>{{ summary }}</p>
        </div>
      </div>
      {% endif %}

      <div class="row mt-3">
        <div class="col-md-6">
          {% if pos_div %}
            {{ pos_div | safe }}
          {% endif %}
        </div>
        <div class="col-md-6">
          {% if neg_div %}
            {{ neg_div | safe }}
          {% endif %}
        </div>
      </div>

      <div class="mt-3">
        {% if table_html %}
          <h4>Entity Table</h4>
          <div>{{ table_html | safe }}</div>
        {% endif %}
      </div>
    </div>

    <script>
      function loadSampleData() {
        const sampleText = `Healer A used herb willow for fever, it worked well.
Healer B used honey for cough; patients improved after two days.
Healer C tried willow for infection, but results were poor.
Healer Anna used garlic for infections â€” patients healed quickly.
Healer John used saltwater for fever â€” it didn't help.
Dr. Old used a poultice of mixed herbs on the wound; some improvement noted.
Elder Mira applied crushed mint for stomach ache, it helped a bit.
Brother Tomas brewed chamomile tea for sleeplessness; it aided sleep.
Healer Signe administered willow bark tincture for fever and fever broke.
Healer Liao attempted river clay poultice for inflammation but condition worsened.
Healer Noor used fermented honey for cough, no improvement observed.`;
        document.getElementById('text').value = sampleText;
        // Visual feedback
        const btn = event.target;
        const originalText = btn.innerHTML;
        btn.innerHTML = 'âœ“ Loaded!';
        btn.classList.add('btn-success');
        setTimeout(() => {
          btn.innerHTML = originalText;
          btn.classList.remove('btn-success');
        }, 1500);
      }

      // Keyboard shortcut: Ctrl+Enter to submit
      document.getElementById('text').addEventListener('keydown', function(e) {
        if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
          e.preventDefault();
          document.querySelector('form').submit();
        }
      });

      // Auto-focus on textarea when page loads
      document.addEventListener('DOMContentLoaded', function() {
        document.getElementById('text').focus();
      });
    </script>
  </body>
  <!-- Chat widget -->
  <div id="chatToggle" class="chat-toggle" role="button" aria-label="Open chat" title="Ask the Healer">
    ğŸ’¬
  </div>
  <div id="chatPanel" class="chat-panel" aria-hidden="true">
    <div class="chat-header">Ask the Healer (RAG placeholder)</div>
    <div id="chatLog" class="chat-log" role="log" aria-live="polite"></div>
    <form id="chatForm" class="chat-input">
      <input id="chatInput" placeholder="Ask: Which cures worked for fever?" aria-label="Question" />
      <button type="submit">Send</button>
    </form>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="/static/chat.js"></script>
  <script src="/static/ui.js"></script>
</html>
